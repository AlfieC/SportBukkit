From 19b4878ea26f900ca73588acad9518af010498b5 Mon Sep 17 00:00:00 2001
From: mrapple <tony@oc.tc>
Date: Sun, 17 Feb 2013 23:15:32 -0600
Subject: [PATCH] Fire PlayerInteractEvent when anyone steps on a pressure plate

In order to not spam the PlayerInteractEvent, we need to keep track of wether or not a plugin allows/denys a player.

This does modify PlayerInteractEvent firing, but it shouldn't be 'breaking'.---
 .../minecraft/server/BlockPressurePlateBinary.java |   30 ++++++++++++++++++--
 1 files changed, 27 insertions(+), 3 deletions(-)

diff --git a/src/main/java/net/minecraft/server/BlockPressurePlateBinary.java b/src/main/java/net/minecraft/server/BlockPressurePlateBinary.java
index ba7b660..5052105 100644
--- a/src/main/java/net/minecraft/server/BlockPressurePlateBinary.java
+++ b/src/main/java/net/minecraft/server/BlockPressurePlateBinary.java
@@ -3,11 +3,17 @@ package net.minecraft.server;
 import java.util.Iterator;
 import java.util.List;

-import org.bukkit.event.entity.EntityInteractEvent; // CraftBukkit
+// CraftBukkit start
+import org.bukkit.event.entity.EntityInteractEvent;
+import java.util.Map;
+import java.util.HashMap;
+import java.util.Iterator;
+// CraftBukkit end

 public class BlockPressurePlateBinary extends BlockPressurePlateAbstract {

     private EnumMobType a;
+    public Map<Object, Boolean> entities = new HashMap<Object, Boolean>(); // CraftBukkit

     protected BlockPressurePlateBinary(int i, String s, Material material, EnumMobType enummobtype) {
         super(i, s, material);
@@ -38,15 +44,31 @@ public class BlockPressurePlateBinary extends BlockPressurePlateAbstract {
         }

         if (!list.isEmpty()) {
+            // CraftBukkit start
+            if(!this.entities.isEmpty()) {
+                Iterator iterator = this.entities.keySet().iterator();
+
+                while(iterator.hasNext()) {
+                    Entity entity = (Entity) iterator.next();
+                    if(!list.contains(entity)) {
+                        iterator.remove();
+                    }
+                }
+            }
+
             Iterator iterator = list.iterator();

             while (iterator.hasNext()) {
                 Entity entity = (Entity) iterator.next();

-                // CraftBukkit start - Fire interact event when turning on a pressure plate
                 org.bukkit.World bworld = world.getWorld();
                 org.bukkit.plugin.PluginManager manager = world.getServer().getPluginManager();
                 org.bukkit.event.Cancellable cancellable;
+                Boolean result = this.entities.get(entity);
+
+                if (entity == null || result != null) {
+                    continue;
+                }

                 if (entity instanceof EntityHuman) {
                     cancellable = org.bukkit.craftbukkit.event.CraftEventFactory.callPlayerInteractEvent((EntityHuman) entity, org.bukkit.event.block.Action.PHYSICAL, i, j, k, -1, null);
@@ -55,13 +77,15 @@ public class BlockPressurePlateBinary extends BlockPressurePlateAbstract {
                     manager.callEvent((EntityInteractEvent) cancellable);
                 }

+                this.entities.put(entity, !cancellable.isCancelled());
+
                 // We only want to block turning the plate on if all events are cancelled
                 if (cancellable.isCancelled()) {
                     continue;
                 }
                 // CraftBukkit end

-                if (!entity.at()) {
+                if (!entity.at() && (result == null || result == true)) {
                     return 15;
                 }
             }
--
1.7.4.4
