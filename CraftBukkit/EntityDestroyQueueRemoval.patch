From 5f32a1155d639260e2be6be537cac085d8e2b8d0 Mon Sep 17 00:00:00 2001
From: Steve Anton <anxuiz.nx@gmail.com>
Date: Thu, 4 Oct 2012 18:29:15 -0700
Subject: [PATCH] Remove the entity destroy queue.

---
 .../java/net/minecraft/server/EntityPlayer.java     |  9 ++++++---
 .../net/minecraft/server/EntityTrackerEntry.java    | 21 ++++++++++++++++++---
 .../org/bukkit/craftbukkit/entity/CraftPlayer.java  |  3 ++-
 3 files changed, 26 insertions(+), 7 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index b991bfa..470c6b5 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -26,7 +26,8 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
     public double d;
     public double e;
     public final List chunkCoordIntPairQueue = new LinkedList();
-    public final List g = new LinkedList();
+    // CraftBukkit - remove entity destroy queue
+    //public final List g = new LinkedList();
     private int ch = -99999999;
     private int ci = -99999999;
     private boolean cj = true;
@@ -184,7 +185,8 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
             }
         }
 
-        if (!this.g.isEmpty()) {
+        // CraftBukkit start - do not use the entity destroy queue
+        /*if (!this.g.isEmpty()) {
             i = Math.min(this.g.size(), 127);
             int[] aint = new int[i];
             Iterator iterator2 = this.g.iterator();
@@ -196,7 +198,8 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
             }
 
             this.netServerHandler.sendPacket(new Packet29DestroyEntity(aint));
-        }
+        }*/
+        // CraftBukkit end
     }
 
     public void g() {
diff --git a/src/main/java/net/minecraft/server/EntityTrackerEntry.java b/src/main/java/net/minecraft/server/EntityTrackerEntry.java
index c504d35..27d0c91 100644
--- a/src/main/java/net/minecraft/server/EntityTrackerEntry.java
+++ b/src/main/java/net/minecraft/server/EntityTrackerEntry.java
@@ -216,7 +216,12 @@ public class EntityTrackerEntry {
         while (iterator.hasNext()) {
             EntityPlayer entityplayer = (EntityPlayer) iterator.next();
 
-            entityplayer.g.add(Integer.valueOf(this.tracker.id));
+            // CraftBukkit start - send the packet immediately instead of queueing it
+            // entityplayer.g.add(Integer.valueOf(this.tracker.id));
+            if(entityplayer.netServerHandler != null) {
+                entityplayer.netServerHandler.sendPacket(new Packet29DestroyEntity(new int[]{ this.tracker.id }));
+            }
+            // CraftBukkit end
         }
     }
 
@@ -290,7 +295,12 @@ public class EntityTrackerEntry {
                 }
             } else if (this.trackedPlayers.contains(entityplayer)) {
                 this.trackedPlayers.remove(entityplayer);
-                entityplayer.g.add(Integer.valueOf(this.tracker.id));
+                // CraftBukkit start - send the packet immediately instead of queueing it
+                // entityplayer.g.add(Integer.valueOf(this.tracker.id));
+                if(entityplayer.netServerHandler != null) {
+                    entityplayer.netServerHandler.sendPacket(new Packet29DestroyEntity(new int[]{ this.tracker.id }));
+                }
+                // CraftBukkit end
             }
         }
     }
@@ -424,7 +434,12 @@ public class EntityTrackerEntry {
     public void clear(EntityPlayer entityplayer) {
         if (this.trackedPlayers.contains(entityplayer)) {
             this.trackedPlayers.remove(entityplayer);
-            entityplayer.g.add(Integer.valueOf(this.tracker.id));
+            // CraftBukkit - send the packet immediately instead of queueing it
+            // entityplayer.g.add(Integer.valueOf(this.tracker.id));
+            if(entityplayer.netServerHandler != null) {
+                entityplayer.netServerHandler.sendPacket(new Packet29DestroyEntity(new int[]{ this.tracker.id }));
+            }
+            // CraftBukkit end
         }
     }
 }
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
index 1b88232..7bcc372 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftPlayer.java
@@ -631,7 +631,8 @@ public class CraftPlayer extends CraftHumanEntity implements Player {
         EntityTracker tracker = ((WorldServer) entity.world).tracker;
         EntityPlayer other = ((CraftPlayer) player).getHandle();
         EntityTrackerEntry entry = (EntityTrackerEntry) tracker.trackedEntities.get(other.id);
-        getHandle().g.remove(Integer.valueOf(other.id)); // Should be called destroyQueue
+        // we do not want to use the destroy entity queue
+        //getHandle().g.remove(Integer.valueOf(other.id)); // Should be called destroyQueue
         if (entry != null && !entry.trackedPlayers.contains(getHandle())) {
             entry.updatePlayer(getHandle());
         }
-- 
1.7.11.msysgit.1

