From 2f0c1ad156363ee86956f8b5f415ee3c509de37b Mon Sep 17 00:00:00 2001
From: mrapple <tony@oc.tc>
Date: Sun, 12 Aug 2012 21:26:54 -0500
Subject: [PATCH] Temporary fix for empty chunks

---
 .../java/net/minecraft/server/EntityPlayer.java    |   27 +++++++++++++++++---
 1 file changed, 23 insertions(+), 4 deletions(-)

diff --git a/src/main/java/net/minecraft/server/EntityPlayer.java b/src/main/java/net/minecraft/server/EntityPlayer.java
index b8696b5..e2c95f6 100644
--- a/src/main/java/net/minecraft/server/EntityPlayer.java
+++ b/src/main/java/net/minecraft/server/EntityPlayer.java
@@ -167,11 +167,30 @@ public class EntityPlayer extends EntityHuman implements ICrafting {
             }
 
             if (!arraylist.isEmpty()) {
-                // CraftBukkit start - don't use map chunk bulk for now TODO: fix this
-                for (Object object : arraylist) {
-                    this.netServerHandler.sendPacket(new Packet51MapChunk((Chunk) object, true, 0xffff));
+                // CraftBukkit start - use map chunk bulk for empty chunks TODO: fix this
+                Iterator it = arraylist.iterator();
+                ArrayList arraylist2 = new ArrayList(arraylist);
+
+                while (it.hasNext()) {
+                    Object obj = it.next();
+                    Chunk chunk = (Chunk) obj;
+
+                    for(int x = 0; x < 16; x++) {
+                        for(int z = 0; z < 16; z++) {
+                            for(int y = 0; y < 256; y++) {
+                                if(chunk.getTypeId(x, y, z) != 0) {
+                                    this.netServerHandler.sendPacket(new Packet51MapChunk(chunk, true, 0xffff));
+                                    removed++;
+                                    arraylist2.remove(obj);
+                                    x = 16;
+                                    z = 16;
+                                    y = 256;
+                                }
+                            }
+                        }
+                    }
                 }
-                // this.netServerHandler.sendPacket(new Packet56MapChunkBulk(arraylist));
+                this.netServerHandler.sendPacket(new Packet56MapChunkBulk(arraylist2));
                 // CraftBukkit end
 
                 Iterator iterator1 = arraylist1.iterator();
-- 
1.7.9.6 (Apple Git-31.1)

